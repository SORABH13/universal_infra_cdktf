name: 🚀 CDKTF Deploy - Dev

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
    inputs:
      cloud:
        description: "Cloud Provider"
        required: true
        type: string
        default: "aws"
      env:
        description: "Environment"
        required: true
        type: string
        default: "dev"

jobs:
  cdktf-deploy:
    name: 🌍 Deploy via CDKTF
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      # 🔐 AWS Auth via OIDC
      - name: 🔐 Configure AWS Credentials
        if: github.event.inputs.cloud == 'aws'
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::141454182275:role/github_pipeline
          aws-region: ap-south-1

      # 🔐 Azure Login if needed
      - name: 🔐 Azure Login
        if: github.event.inputs.cloud == 'azure'
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # 🧱 Install CDKTF CLI
      - name: 📦 Install CDKTF CLI
        run: npm install -g cdktf-cli

      # 📜 Install dependencies
      - name: 📦 Install project dependencies
        run: npm install
      
      - name: Set ENV variable
        run: echo "ENV=${{ github.event.inputs.env }}" >> $GITHUB_ENV
        
      # 🔧 Get Providers and Synthesize
      - name: 🔄 CDKTF Get & Synth
        run: |
          cdktf get
          cdktf synth

      # 🚀 Deploy Specific CDKTF Stack
      - name: 🚀 Deploy CDKTF Stack
        run: cdktf deploy --auto-approve
