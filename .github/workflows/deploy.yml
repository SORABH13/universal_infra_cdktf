name: ðŸš€ CDKTF Deploy - Dev

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
    inputs:
      cloud:
        description: "Cloud Provider"
        required: true
        type: string
        default: "aws"
      env:
        description: "Environment"
        required: true
        type: string
        default: "dev"

jobs:
  cdktf-deploy:
    name: ðŸŒ Deploy via CDKTF
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # ðŸ” AWS Auth via OIDC
      - name: ðŸ” Configure AWS Credentials
        if: github.event.inputs.cloud == 'aws'
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::141454182275:role/github_pipeline
          aws-region: ap-south-1

      # ðŸ” Azure Login if needed
      - name: ðŸ” Azure Login
        if: github.event.inputs.cloud == 'azure'
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # ðŸ§± Install CDKTF CLI
      - name: ðŸ“¦ Install CDKTF CLI
        run: npm install -g cdktf-cli

      # ðŸ“œ Install dependencies
      - name: ðŸ“¦ Install project dependencies
        run: npm install
      
      - name: Set ENV variable
        run: echo "ENV=${{ github.event.inputs.env }}" >> $GITHUB_ENV
        
      # ðŸ”§ Get Providers and Synthesize
      - name: ðŸ”„ CDKTF Get & Synth
        run: |
          cdktf get
          cdktf synth

      # ðŸš€ Deploy Specific CDKTF Stack
      - name: ðŸš€ Deploy CDKTF Stack
        run: cdktf deploy --auto-approve
